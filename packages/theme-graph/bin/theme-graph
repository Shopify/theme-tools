#!/usr/bin/env node

const { buildThemeGraph, serializeThemeGraph, toSourceCode } = require('@shopify/theme-graph');
const {
  NodeFileSystem,
  memoize,
  toSchema,
  path: pathUtils,
  recursiveReadDirectory,
} = require('@shopify/theme-check-node');
const path = require('path');
const { URI } = require('vscode-uri');

/**
 * @param {string} root
 */
async function main(root) {
  if (!root) {
    console.error('Usage: theme-graph <path-to-theme-directory>');
    process.exit(1);
  }

  if (!path.isAbsolute(root)) {
    root = path.resolve(process.cwd(), root);
  }
  const identity = (/** @type {any} */ x) => x;
  const getSourceCode = makeGetSourceCode();
  // preload for shits n giggles
  const fs = NodeFileSystem;
  const rootUri = URI.file(root).toString(true);
  const filesToPreload = await recursiveReadDirectory(fs, rootUri, ([uri]) =>
    ['.json', '.liquid'].some((ext) => uri.endsWith(ext)),
  );

  // preload
  await bench('Preloading files', async () => {
    await Promise.all(
      filesToPreload.map(async (uri) => {
        await getSourceCode(uri);
      }),
    );
  });

  // @ts-ignore
  const webComponentDefs = new Map();
  /** @type {import('@shopify/theme-graph').Dependencies} */
  const dependencies = {
    fs,
    // @ts-ignore
    getSectionSchema: memoize(async (name) => {
      const uri = pathUtils.join(rootUri, 'sections', `${name}.liquid`);
      const sourceCode = await getSourceCode(uri);
      // @ts-ignore
      return await toSchema('theme', uri, sourceCode, async () => true);
    }, identity),
    // @ts-ignore
    getBlockSchema: memoize(async (name) => {
      const uri = pathUtils.join(rootUri, 'blocks', `${name}.liquid`);
      const sourceCode = await getSourceCode(uri);
      // @ts-ignore
      return await toSchema('theme', uri, sourceCode, async () => true);
    }, identity),
    getSourceCode,
    getWebComponentDefinitionReference: (/** @type {string} */ customElementName) =>
      webComponentDefs.get(customElementName),
  };

  const graph = await bench('Build graph', () =>
    buildThemeGraph(URI.file(root).toString(true), dependencies),
  );
  const serializedGraph = serializeThemeGraph(graph);
  console.log(JSON.stringify(serializedGraph));
}

function makeGetSourceCode() {
  return memoize(
    async function getSourceCode(uri) {
      const source = await NodeFileSystem.readFile(uri);
      return await toSourceCode(URI.file(uri).toString(), source);
    },
    (x) => x,
  );
}

// @ts-ignore
async function bench(name, fn) {
  const start = performance.now();
  // @ts-ignore
  const result = await fn();
  // @ts-ignore
  const end = performance.now();
  console.error(`${name} took ${end - start}ms`);
  return result;
}

main(process.argv[2]);
